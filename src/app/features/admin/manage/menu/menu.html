<div class="h-full flex flex-col p-6">
    <!-- Header with back button -->
    <div class="flex items-center gap-4 mb-6">
        <a [routerLink]="['/admin/manage']"
           class="flex items-center gap-2 px-4 py-2 rounded-lg bg-surface-100 dark:bg-surface-800 text-surface-700 dark:text-surface-300 hover:bg-surface-200 dark:hover:bg-surface-700 transition-colors duration-200">
            <i class="pi pi-arrow-left"></i>
            <span>Volver al gestor</span>
        </a>
        <h1 class="text-3xl font-bold text-surface-900 dark:text-surface-0">{{ title }}</h1>
    </div>

    <p class="text-surface-600 dark:text-surface-400 mb-8">{{ description }}</p>

    <!-- Day Menu Creation Form -->
    <p-card header="Crear Nuevo Menú del Día" class="mb-6">
        <form [formGroup]="dayMenuForm" (ngSubmit)="onSubmit()" class="space-y-6">
            <!-- Name Field -->
            <div class="field">
                <label for="name" class="block text-sm font-medium text-surface-700 dark:text-surface-300 mb-2">
                    Nombre del Menú *
                </label>
                <input
                    id="name"
                    type="text"
                    pInputText
                    formControlName="name"
                    placeholder="Ej: Menú Ejecutivo del Día - 2024-01-15"
                    class="w-full"
                    [class.ng-invalid]="dayMenuForm.get('name')?.invalid && dayMenuForm.get('name')?.touched"
                />
                @if (getFieldError('name')) {
                  <small class="text-red-500">{{ getFieldError('name') }}</small>
                }
            </div>

            <!-- Price Field -->
            <div class="field">
                <label for="price" class="block text-sm font-medium text-surface-700 dark:text-surface-300 mb-2">
                    Precio (COP) *
                </label>
                <p-inputNumber
                    id="price"
                    formControlName="price"
                    mode="currency"
                    currency="COP"
                    locale="es-CO"
                    [min]="0"
                    [class.ng-invalid]="dayMenuForm.get('price')?.invalid && dayMenuForm.get('price')?.touched"
                ></p-inputNumber>
                @if (getFieldError('price')) {
                  <small class="text-red-500">{{ getFieldError('price') }}</small>
                }
            </div>

            <!-- Categories and Products Section -->
            <div class="field">
                <div class="flex justify-between items-center mb-4">
                    <label class="block text-sm font-medium text-surface-700 dark:text-surface-300">
                        Categorías y Productos *
                    </label>
                    <p-button
                        type="button"
                        label="Agregar Categoría"
                        icon="pi pi-plus"
                        size="small"
                        (onClick)="addCategory()"
                    ></p-button>
                </div>

                <div formArrayName="products" class="space-y-4">
                    @for (categoryControl of productsFormArray.controls; track i; let i = $index) {
                      <div
                          [formGroupName]="i"
                          class="border border-surface-200 dark:border-surface-700 rounded-lg p-4"
                      >
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-sm font-medium text-surface-700 dark:text-surface-300">
                                Categoría {{ i + 1 }}
                            </h4>
                            <p-button
                                type="button"
                                icon="pi pi-trash"
                                size="small"
                                severity="danger"
                                [text]="true"
                                (onClick)="removeCategory(i)"
                            ></p-button>
                        </div>

                        <!-- Category Selection -->
                        <div class="field mb-3">
                            <label class="block text-xs font-medium text-surface-600 dark:text-surface-400 mb-1">
                                Categoría *
                            </label>
                            <p-select
                                formControlName="categoryId"
                                [options]="availableCategories()"
                                optionLabel="name"
                                optionValue="id"
                                placeholder="Selecciona una categoría"
                                [class.ng-invalid]="categoryControl.get('categoryId')?.invalid && categoryControl.get('categoryId')?.touched"
                                (onChange)="onCategoryChange(i)"
                                class="w-full"
                            ></p-select>
                        </div>

                        <!-- Products Selection -->
                        <div class="field">
                            <label class="block text-xs font-medium text-surface-600 dark:text-surface-400 mb-1">
                                Productos *
                            </label>
                            @if (loadingProducts()) {
                              <div class="flex items-center gap-2 text-surface-500">
                                  <i class="pi pi-spin pi-spinner"></i>
                                  <span>Cargando productos...</span>
                              </div>
                            }
                            <p-multiSelect
                                formControlName="productIds"
                                [options]="getFilteredProducts(categoryControl.get('categoryId')?.value)"
                                optionLabel="name"
                                optionValue="id"
                                placeholder="{{ categoryControl.get('categoryId')?.value ? 'Selecciona los productos' : 'Primero selecciona una categoría' }}"
                                display="chip"
                                [disabled]="!categoryControl.get('categoryId')?.value || loadingProducts()"
                                [class.ng-invalid]="categoryControl.get('productIds')?.invalid && categoryControl.get('productIds')?.touched"
                                class="w-full"
                            ></p-multiSelect>
                            @if (categoryControl.get('categoryId')?.value && getFilteredProducts(categoryControl.get('categoryId')?.value).length === 0 && !loadingProducts()) {
                              <small class="text-surface-500 mt-1 block">
                                  No hay productos disponibles en esta categoría
                              </small>
                            }
                        </div>
                      </div>
                    }
                </div>

                @if (productsFormArray.length === 0) {
                  <small class="text-surface-500 dark:text-surface-400 mt-2 block">
                      Agrega al menos una categoría con productos
                  </small>
                }
            </div>

            <!-- Submit Button -->
            <div class="flex justify-end">
                <p-button
                    type="submit"
                    label="Crear Menú del Día"
                    icon="pi pi-plus"
                    [loading]="isSubmitting()"
                    [disabled]="dayMenuForm.invalid"
                ></p-button>
            </div>
        </form>
    </p-card>
</div>

<p-toast></p-toast>
