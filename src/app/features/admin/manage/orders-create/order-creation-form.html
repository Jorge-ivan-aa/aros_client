<div class="h-full flex flex-col p-6">
  <div class="flex items-center gap-4 mb-6">
    <a [routerLink]="['/admin/manage']"
      class="flex items-center gap-2 px-4 py-2 rounded-lg bg-surface-100 dark:bg-surface-800 text-surface-700 dark:text-surface-300 hover:bg-surface-200 dark:hover:bg-surface-700 transition-colors duration-200">
      <i class="pi pi-arrow-left"></i>
      <span>Volver al gestor</span>
    </a>
    <h1 class="text-3xl font-bold text-surface-900 dark:text-surface-0">{{ title }}</h1>
  </div>

  <p class="text-surface-600 dark:text-surface-400 mb-8">{{ description }}</p>

  <div class="bg-surface-0 dark:bg-surface-800 rounded-lg shadow-sm border border-surface-200 dark:border-surface-700 p-6">
    <form [formGroup]="form" (ngSubmit)="submit()" class="space-y-6">
      <div>
        <label class="block text-sm font-medium mb-2" for="table-id">Mesa (ID)</label>
        <input id="table-id" type="number" formControlName="table" min="1" class="w-full border rounded p-2 bg-transparent" placeholder="Ej. 5" />
      </div>

      <div class="rounded border border-surface-200 dark:border-surface-700 bg-surface-50 dark:bg-surface-900/40 p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-sm font-semibold text-surface-700 dark:text-surface-300">Productos disponibles</h2>
          @if (productsLoading) {
            <span class="text-xs text-surface-500">Cargando...</span>
          }
        </div>

        @if (!productsLoading && products.length === 0) {
          <p class="text-xs text-surface-500">No hay productos disponibles. Verifica que existan productos registrados.</p>
        }

        @if (products.length > 0) {
        <ul class="grid gap-2 sm:grid-cols-2">
          @for (product of products; track product.id) {
            <li class="text-xs text-surface-600 dark:text-surface-400">
              <span class="font-semibold text-surface-800 dark:text-surface-200">{{ product.name }}</span>
              <span class="ml-2 text-surface-500">{{ product.price | currency:'COP':'symbol-narrow' }}</span>
              <div class="text-[11px] text-surface-500">{{ product.description }}</div>
            </li>
          }
        </ul>
        }
      </div>

      <div>
        <div class="flex items-center justify-between mb-2">
          <span class="block text-sm font-medium">Órdenes de cliente</span>
          <button type="button" (click)="addClientOrder()" class="px-3 py-1 rounded bg-surface-100 dark:bg-surface-700 hover:bg-surface-200 dark:hover:bg-surface-600">Agregar orden</button>
        </div>

        <div class="space-y-4">
          @for (co of clientOrders.controls; track $index; let i = $index) {
          <div class="rounded border p-4">
            <div class="flex items-center justify-between mb-3">
              <div class="font-medium">Orden de cliente #{{ i + 1 }}</div>
              <button type="button" (click)="removeClientOrder(i)" class="text-sm text-red-600 hover:underline" [disabled]="clientOrders.length === 1">Quitar</button>
            </div>

            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <div class="text-sm font-medium">Detalles</div>
                <button type="button" (click)="addDetail(i)" class="px-2 py-1 rounded bg-surface-100 dark:bg-surface-700 hover:bg-surface-200 dark:hover:bg-surface-600 text-sm">Agregar detalle</button>
              </div>

              <div class="space-y-3">
                @for (d of detailsAt(i).controls; track $index; let j = $index) {
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end border rounded p-3" [formGroup]="$any(detailsAt(i).at(j))">
                  <div>
                    <label class="block text-xs mb-1" [attr.for]="'product-' + i + '-' + j">Producto</label>
                    <select [id]="'product-' + i + '-' + j" formControlName="product" class="w-full border rounded p-2 bg-transparent">
                      <option [ngValue]="null" disabled>Seleccione un producto</option>
                      @for (product of products; track product.id) {
                        <option [ngValue]="product.id">{{ product.name }} · {{ product.price | currency:'COP':'symbol-narrow' }}</option>
                      }
                    </select>
                  </div>
                  <div>
                    <label class="block text-xs mb-1" [attr.for]="'quantity-' + i + '-' + j">Cantidad</label>
                    <input [id]="'quantity-' + i + '-' + j" type="number" formControlName="quantity" min="1" class="w-full border rounded p-2 bg-transparent" />
                  </div>
                  <div>
                    <label class="block text-xs mb-1" [attr.for]="'observations-' + i + '-' + j">Observaciones</label>
                    <input [id]="'observations-' + i + '-' + j" type="text" formControlName="observations" class="w-full border rounded p-2 bg-transparent" placeholder="Sin cebolla" />
                  </div>
                  <div>
                    <label class="block text-xs mb-1" [attr.for]="'subproducts-' + i + '-' + j">Subproductos (opcional, IDs separados por coma)</label>
                    <input [id]="'subproducts-' + i + '-' + j" type="text" formControlName="subProducts" class="w-full border rounded p-2 bg-transparent" placeholder="Ej. 1, 2, 3 (dejar vacío si no aplica)" />
                  </div>
                  <div class="md:col-span-4 flex justify-end">
                    <button type="button" (click)="removeDetail(i, j)" class="text-sm text-red-600 hover:underline" [disabled]="detailsAt(i).length === 1">Quitar detalle</button>
                  </div>
                </div>
                }
              </div>
            </div>
          </div>
          }
        </div>
      </div>

      <div class="flex gap-2">
        <button type="submit" class="px-4 py-2 rounded bg-primary-500 text-white hover:bg-primary-600 disabled:opacity-60" [disabled]="isSubmitDisabled">Crear pedido</button>
        <a [routerLink]="['/admin/manage']" class="px-4 py-2 rounded bg-surface-200 dark:bg-surface-700 hover:bg-surface-300 dark:hover:bg-surface-600">Cancelar</a>
      </div>
    </form>
  </div>
</div>
